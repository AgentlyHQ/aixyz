# Custom Server

Create `app/server.ts` for full control. This overrides auto-generation.

## Example

```ts
import { AixyzServer } from "aixyz/server";
import { useA2A } from "aixyz/server/adapters/a2a";
import { AixyzMCP } from "aixyz/server/adapters/mcp";

import * as agent from "./agent";
import lookup from "./tools/lookup";

const server = new AixyzServer();
await server.initialize();

useA2A(server, agent);

const mcp = new AixyzMCP(server);
await mcp.register("lookup", {
  default: lookup,
  accepts: { scheme: "exact", price: "$0.001" },
});
await mcp.connect();

export default server;
```

## APIs

### `AixyzServer`

Express 5 server with x402 payment verification. Extends `x402ResourceServer`.

- `server.express` — the raw Express app
- `server.config` — parsed `AixyzConfig`
- `server.withX402(route, accepts)` — add x402 middleware to a route
- `server.initialize()` — initialize the x402 resource server

### `useA2A(server, agentExports, taskStore?)`

Registers:

- `GET /.well-known/agent-card.json` — agent card
- `POST /agent` — JSON-RPC handler (x402-gated if `accepts.scheme === "exact"`)

The `agentExports` parameter is `import * as agent from "./agent"` — it reads both `default` (the agent) and `accepts` (payment config).

### `AixyzMCP`

- `mcp.register(name, { default: tool, accepts })` — register a tool
- `mcp.connect()` — mount `POST /mcp` endpoint

Tools must have an `execute` function. Payment wrapping applied if `accepts.scheme === "exact"`.

## Build Behavior

The build process handles server exports differently based on the target:

- **Default build** (`aixyz build`): Exports the server object and auto-starts it when run as main module. The bundled file at `.aixyz/output/server.js` can be executed directly with `bun .aixyz/output/server.js`.

- **Vercel build** (`aixyz build --vercel` or `VERCEL=1`): Transforms `export default server` to `export default server.express` for Vercel serverless function compatibility. The Express app is exported without auto-start. Vercel environment is automatically detected via the `VERCEL=1` environment variable.
