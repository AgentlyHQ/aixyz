---
title: "Testing"
description: "Test your agent with bun:test and aixyz/test utilities"
---

## Overview

aixyz provides a `loadEnv` utility from `aixyz/test` for loading environment variables during tests. Combined with Bun's built-in test runner, you can write both deterministic and non-deterministic agent tests.

## Test File Convention

Place your test file alongside your agent:

```
app/
  agent.ts
  agent.test.ts    # Tests for the agent
  tools/
    weather.ts
```

## Writing Tests

```typescript
import { describe, expect, test } from "bun:test";
import { ToolLoopAgent } from "ai";
import { loadEnv } from "aixyz/test";
import agent, { accepts } from "./agent";

// Deterministic tests — no API calls, always run
test("default export is a ToolLoopAgent", () => {
  expect(agent).toBeInstanceOf(ToolLoopAgent);
});

test("has convertTemperature tool registered", () => {
  expect(agent.tools).toHaveProperty("convertTemperature");
});

test("accepts config uses exact scheme", () => {
  expect(accepts.scheme).toBe("exact");
});

// Non-deterministic tests — require API key, skip gracefully in CI
describe("non deterministic agent test", () => {
  loadEnv();

  test.skipIf(!process.env.OPENAI_API_KEY)("agent can convert temperature", async () => {
    const result = await agent.generate({
      prompt: "convert 100 degrees celsius to fahrenheit",
    });
    expect(result.text).toContain("212");
  });
});
```

## `loadEnv()`

The `loadEnv` function from `aixyz/test` loads environment variables for test runs. It loads `.env.test.local` (where your `OPENAI_API_KEY` lives for tests) while `.env.local` is ignored during testing.

```typescript
import { loadEnv } from "aixyz/test";

describe("tests needing env vars", () => {
  loadEnv();

  // process.env is now populated
});
```

## Deterministic vs Non-Deterministic

| Type              | Description                            | CI-Safe |
| ----------------- | -------------------------------------- | ------- |
| Deterministic     | Validate agent type, tools, config     | Yes     |
| Non-deterministic | Call LLM and validate response content | No\*    |

\* Use `test.skipIf(!process.env.OPENAI_API_KEY)` to skip gracefully when no API key is available.

## Fully Offline Tests with `fake()`

Use `fake()` from `aixyz/model` to replace the real LLM with a deterministic transform. Every test becomes CI-safe and runs without an API key:

```typescript
import { fake } from "aixyz/model";
import { ToolLoopAgent } from "ai";

export const model = fake((lastMessage) => `You said: ${lastMessage}`);

export default new ToolLoopAgent({ model, instructions: "..." });
```

Then test the model's output directly:

```typescript
import { model } from "./agent";

test("echoes back the user message", async () => {
  const result = await model.doGenerate({
    prompt: [{ role: "user", content: [{ type: "text", text: "hello" }] }],
  });
  expect(result.content[0].text).toBe("You said: hello");
});
```

See the [Fake Model Agent template](/templates/advanced/agent-fake-model) for a complete working example.

## Running Tests

```bash
# Run all tests
bun test

# Run a specific test file
bun test app/agent.test.ts
```
